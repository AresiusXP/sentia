{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "rgName": {
        "type": "string"
      },
      "location": {
        "type": "string",
        "defaultValue": "[deployment().location]"
      },
      "spnObjectId": {
          "type": "string"
      },
      "secondaryLocation": {
          "type": "string"
      },
      "mySqlPass": {
          "type": "securestring",
          "metadata": {
              "description": "Password for MySQL sa user."
          }
      },
      "omsWorkspaceName": {
          "type": "string",
          "metadata": {
              "description": "Log Analytics Workspace name for diagnostic settings."
          }
      },
      "aksObjectId": {
          "type": "string",
          "metadata": {
              "description": "SPN Object ID to be used by AKS"
          }
      },
      "aksClientId": {
          "type": "string",
          "metadata": {
              "description": "SPN Client ID to be used by AKS"
          }
      },
      "aksSPNSecret": {
          "type": "string",
          "metadata": {
              "description": "SPN secret to be used by AKS"
          }
      }
    },
    "variables": {
        "templatesUri": "https://raw.githubusercontent.com/AresiusXP/sentia/master/ARM/",
        "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('omsWorkspaceName'))]"
    },
    "resources": [
        {
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2018-05-01",
            "location": "[parameters('location')]",
            "name": "[parameters('rgName')]",
            "properties": {}
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "name": "storageCDN",
            "resourceGroup": "[parameters('rgName')]",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups/', parameters('rgName'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('templatesUri'), 'Storage/storage.json')]"
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "name": "keyvault",
            "resourceGroup": "[parameters('rgName')]",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups/', parameters('rgName'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('templatesUri'), 'KeyVault/keyvault.json')]"
                },
                "parameters": {
                    "objectId": {
                        "value": "[parameters('spnObjectId')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "name": "containerRegistry",
            "resourceGroup": "[parameters('rgName')]",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups/', parameters('rgName'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('templatesUri'), 'Registry/registry.json')]"
                },
                "parameters": {
                    "acrReplicaLocation": {
                        "value": "[parameters('secondaryLocation')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "name": "redis",
            "resourceGroup": "[parameters('rgName')]",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups/', parameters('rgName'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('templatesUri'), 'Redis/redis.json')]"
                },
                "parameters": {
                    "workspaceId": {
                        "value": "[variables('workspaceId')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "name": "mySql",
            "resourceGroup": "[parameters('rgName')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('templatesUri'), 'DB/mysql.json')]"
                },
                "parameters": {
                    "administratorLoginPassword": {
                        "value": "[parameters('mySqlPass')]"
                    },
                    "keyvaultName": {
                        "value": "[reference('keyvault').outputs.keyvaultName.value]"
                    },
                    "secondaryLocation": {
                        "value": "[parameters('secondaryLocation')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "name": "aks",
            "resourceGroup": "[parameters('rgName')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('templatesUri'), 'AKS/aks.json')]"
                },
                "parameters": {
                    "location": {
                        "value": "[if(equals(copyIndex(),0),parameters('location'),parameters('secondaryLocation'))]"
                    },
                    "dnsPrefix": {
                        "value": "[concat('sentia',copyIndex())]"
                    },
                    "existingServicePrincipalObjectId": {
                        "value": "[parameters('aksObjectId')]"
                    },
                    "existingServicePrincipalClientId": {
                        "value": "[parameters('aksClientId')]"
                    },
                    "existingServicePrincipalClientSecret": {
                        "value": "[parameters('aksSPNSecret')]"
                    },
                    "workspaceId": {
                        "value": "[variables('workspaceId')]"
                    },
                    "secondaryNetwork": {
                        "value": "[if(equals(copyIndex(),0), bool('false'), bool('true'))]"
                    }
                }
            },
            "copy": {
                "name": "aksClusters",
                "count": 1,
                "mode": "Parallel"
            }
        }
    ],
    "outputs": {}
  }